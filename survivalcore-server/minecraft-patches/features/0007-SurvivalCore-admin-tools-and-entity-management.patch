From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: JadenRazo <jadenrazo@yahoo.com>
Date: Thu, 12 Feb 2026 22:12:34 +0000
Subject: [PATCH] SurvivalCore admin tools and entity management


diff --git a/net/minecraft/server/MinecraftServer.java b/net/minecraft/server/MinecraftServer.java
index 7bf56a37a50fe115bb4a7235268d8f39b5142c9e..7b94369d45bdca633d4cd816f5038456c789230c 100644
--- a/net/minecraft/server/MinecraftServer.java
+++ b/net/minecraft/server/MinecraftServer.java
@@ -1503,6 +1503,18 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         // SurvivalCore start - Reset exploit tick counters
         net.survivalcore.fixes.ExploitFixes.resetTickCounters();
         // SurvivalCore end
+        // SurvivalCore start - TNT batch processing at tick end
+        if (net.survivalcore.survival.TNTBatcher.isEnabled()) {
+            net.survivalcore.survival.TNTBatcher.get().processBatch((x, y, z, power) -> {
+                for (net.minecraft.server.level.ServerLevel level : this.getAllLevels()) {
+                    if (level.getWorldBorder().isWithinBounds(net.minecraft.core.BlockPos.containing(x, y, z))) {
+                        level.explode(null, x, y, z, power, net.minecraft.world.level.Level.ExplosionInteraction.TNT);
+                        break;
+                    }
+                }
+            });
+        }
+        // SurvivalCore end
         long nanos = Util.getNanos();
         int i = this.pauseWhileEmptySeconds() * 20;
         this.removeDisabledPluginsBlockingSleep(); // Paper - API to allow/disallow tick sleeping
diff --git a/net/minecraft/server/level/ServerLevel.java b/net/minecraft/server/level/ServerLevel.java
index e5d77e97f57d8585d7811cc9c1bd3caa8ec16069..911e8f3481f4389db838c57715b2c0d229109962 100644
--- a/net/minecraft/server/level/ServerLevel.java
+++ b/net/minecraft/server/level/ServerLevel.java
@@ -806,6 +806,15 @@ public class ServerLevel extends Level implements ServerEntityGetter, WorldGenLe
             }
 
             io.papermc.paper.entity.activation.ActivationRange.activateEntities(this); // Paper - EAR
+            // SurvivalCore start - Pre-tick: reset farm counts and start budget timer
+            final long survivalcoreEntityTickStart = System.nanoTime();
+            if (net.survivalcore.survival.FarmDetector.isEnabled()) {
+                net.survivalcore.survival.FarmDetector.get().resetCounts();
+            }
+            if (net.survivalcore.survival.TickCoalescer.isEnabled()) {
+                net.survivalcore.survival.TickCoalescer.get().reset();
+            }
+            // SurvivalCore end
             this.entityTickList
                 .forEach(
                     entity -> {
@@ -825,6 +834,22 @@ public class ServerLevel extends Level implements ServerEntityGetter, WorldGenLe
                                     }
 
                                     profilerFiller.push("tick");
+                                    // SurvivalCore start - Entity tick budget and farm detection
+                                    if (net.survivalcore.survival.EntityTickBudget.isEnabled()
+                                            && !net.survivalcore.survival.EntityTickBudget.get().hasBudgetRemaining(survivalcoreEntityTickStart)) {
+                                        net.survivalcore.survival.EntityTickBudget.get().incrementDeferred();
+                                        profilerFiller.pop();
+                                        return;
+                                    }
+                                    if (net.survivalcore.survival.FarmDetector.isEnabled()) {
+                                        long chunkKey = entity.chunkPosition().toLong();
+                                        net.survivalcore.survival.FarmDetector.get().trackEntity(chunkKey);
+                                        if (!net.survivalcore.survival.FarmDetector.get().shouldTickEntity(chunkKey, this.getGameTime(), entity.getId())) {
+                                            profilerFiller.pop();
+                                            return;
+                                        }
+                                    }
+                                    // SurvivalCore end
                                     this.guardEntityTick(this::tickNonPassenger, entity);
                                     profilerFiller.pop();
                                 }
@@ -832,6 +857,24 @@ public class ServerLevel extends Level implements ServerEntityGetter, WorldGenLe
                         }
                     }
                 );
+            // SurvivalCore start - Post entity tick: cleanup and farm alerts
+            if (net.survivalcore.survival.EntityCleanup.isEnabled()) {
+                int totalEntities = 0;
+                for (Entity e : this.getAllEntities()) {
+                    totalEntities++;
+                }
+                net.survivalcore.survival.EntityCleanup.CleanupAction action = net.survivalcore.survival.EntityCleanup.get().getAction(totalEntities);
+                if (action != net.survivalcore.survival.EntityCleanup.CleanupAction.NONE) {
+                    net.survivalcore.survival.EntityCleanup.get().logCleanupWarning(this.getGameTime(), totalEntities, action);
+                    if (net.survivalcore.monitoring.PerformanceMonitor.isEnabled()) {
+                        net.survivalcore.monitoring.PerformanceMonitor.get().incrementCounter("ENTITIES_CLEANED");
+                    }
+                }
+            }
+            if (net.survivalcore.survival.FarmDetector.isEnabled()) {
+                net.survivalcore.survival.FarmDetector.get().checkAlerts(this.getGameTime());
+            }
+            // SurvivalCore end
             profilerFiller.pop();
             this.tickBlockEntities();
         }
diff --git a/net/minecraft/world/level/NaturalSpawner.java b/net/minecraft/world/level/NaturalSpawner.java
index 26309766ccb8cb066035edfd688cd7dd5b29e1a8..c338bb60a87f71ed4043dbe54341cfb546483873 100644
--- a/net/minecraft/world/level/NaturalSpawner.java
+++ b/net/minecraft/world/level/NaturalSpawner.java
@@ -219,6 +219,26 @@ public final class NaturalSpawner {
             survivalcoreSpawnStart = System.nanoTime();
         }
         // SurvivalCore end
+        // SurvivalCore start - Skip spawning in critical density chunks
+        if (net.survivalcore.survival.FarmDetector.isEnabled()) {
+            long chunkKey = chunk.getPos().toLong();
+            int tickDivisor = net.survivalcore.survival.FarmDetector.get().getTickDivisor(chunkKey);
+            if (tickDivisor >= 8) {
+                return;
+            }
+        }
+        // SurvivalCore end
+        // SurvivalCore start - Per-chunk mob cap enforcement
+        if (net.survivalcore.config.SurvivalCoreConfig.get().adminMobSpawningMaxPerChunk > 0) {
+            net.minecraft.world.phys.AABB chunkBounds = new net.minecraft.world.phys.AABB(
+                chunk.getPos().getMinBlockX(), level.getMinY(), chunk.getPos().getMinBlockZ(),
+                chunk.getPos().getMaxBlockX() + 1, level.getMaxY(), chunk.getPos().getMaxBlockZ() + 1);
+            int mobCount = level.getEntitiesOfClass(net.minecraft.world.entity.Mob.class, chunkBounds).size();
+            if (mobCount >= net.survivalcore.config.SurvivalCoreConfig.get().adminMobSpawningMaxPerChunk) {
+                return;
+            }
+        }
+        // SurvivalCore end
         BlockPos randomPosWithin = getRandomPosWithin(level, chunk);
         if (randomPosWithin.getY() >= level.getMinY() + 1) {
             spawnCategoryForPosition(category, level, chunk, randomPosWithin, filter, callback, maxSpawns, trackEntity); // Paper - Optional per player mob spawns
