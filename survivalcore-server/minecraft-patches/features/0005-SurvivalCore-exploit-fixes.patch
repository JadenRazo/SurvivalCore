From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: JadenRazo <jadenrazo@yahoo.com>
Date: Thu, 12 Feb 2026 22:08:08 +0000
Subject: [PATCH] SurvivalCore exploit fixes


diff --git a/net/minecraft/server/MinecraftServer.java b/net/minecraft/server/MinecraftServer.java
index 94d4ef4d7d848fdf42f426b1a01c313b35b22199..7bf56a37a50fe115bb4a7235268d8f39b5142c9e 100644
--- a/net/minecraft/server/MinecraftServer.java
+++ b/net/minecraft/server/MinecraftServer.java
@@ -1500,6 +1500,9 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
             net.survivalcore.monitoring.PerformanceMonitor.get().tick();
         }
         // SurvivalCore end
+        // SurvivalCore start - Reset exploit tick counters
+        net.survivalcore.fixes.ExploitFixes.resetTickCounters();
+        // SurvivalCore end
         long nanos = Util.getNanos();
         int i = this.pauseWhileEmptySeconds() * 20;
         this.removeDisabledPluginsBlockingSleep(); // Paper - API to allow/disallow tick sleeping
diff --git a/net/minecraft/world/entity/projectile/ThrownEnderpearl.java b/net/minecraft/world/entity/projectile/ThrownEnderpearl.java
index 5aa63c90e1c0605faef76588efdc7c3903be4605..18a2591726e690b7977a973da95595c05d9e92c0 100644
--- a/net/minecraft/world/entity/projectile/ThrownEnderpearl.java
+++ b/net/minecraft/world/entity/projectile/ThrownEnderpearl.java
@@ -116,6 +116,17 @@ public class ThrownEnderpearl extends ThrowableItemProjectile {
         if (this.level() instanceof ServerLevel serverLevel && !this.isRemoved()) {
             Entity owner = this.getOwner();
             if (owner != null && isAllowedToTeleportOwner(owner, serverLevel)) {
+                // SurvivalCore start - Ender pearl world border bypass fix
+                if (net.survivalcore.config.SurvivalCoreConfig.get().fixEnderPearlBorderBypass) {
+                    net.minecraft.world.level.border.WorldBorder border = serverLevel.getWorldBorder();
+                    if (!net.survivalcore.fixes.ExploitFixes.isEnderPearlTeleportValid(
+                            this.getX(), this.getZ(),
+                            border.getCenterX(), border.getCenterZ(), border.getSize())) {
+                        this.discard(org.bukkit.event.entity.EntityRemoveEvent.Cause.HIT);
+                        return;
+                    }
+                }
+                // SurvivalCore end
                 Vec3 vec3 = this.oldPosition();
                 if (owner instanceof ServerPlayer serverPlayer) {
                     if (serverPlayer.connection.isAcceptingMessages()) {
diff --git a/net/minecraft/world/level/block/BedBlock.java b/net/minecraft/world/level/block/BedBlock.java
index e72ead9ff6541f821a61ad3c50fe068a8c8bb69d..66e3516157803cb3be6f468a4c8d413aedfcafeb 100644
--- a/net/minecraft/world/level/block/BedBlock.java
+++ b/net/minecraft/world/level/block/BedBlock.java
@@ -138,6 +138,11 @@ public class BedBlock extends HorizontalDirectionalBlock implements EntityBlock
 
     // CraftBukkit start - Copied from the above method
     private InteractionResult explodeBed(BlockState state, Level level, BlockPos pos) {
+        // SurvivalCore start - Configurable bed explosions
+        if (!net.survivalcore.fixes.ExploitFixes.shouldBedExplode()) {
+            return InteractionResult.SUCCESS_SERVER;
+        }
+        // SurvivalCore end
         org.bukkit.block.BlockState blockState = org.bukkit.craftbukkit.block.CraftBlock.at(level, pos).getState(); // CraftBukkit - capture BlockState before remove block
         level.removeBlock(pos, false);
         BlockPos blockPos = pos.relative(state.getValue(FACING).getOpposite());
diff --git a/net/minecraft/world/level/block/NetherPortalBlock.java b/net/minecraft/world/level/block/NetherPortalBlock.java
index 6c5629a6f5f91496a55eb0bf281ceae1567915b1..c3cfebb8dc253909d9ead181af2135f006f328e4 100644
--- a/net/minecraft/world/level/block/NetherPortalBlock.java
+++ b/net/minecraft/world/level/block/NetherPortalBlock.java
@@ -184,6 +184,22 @@ public class NetherPortalBlock extends Block implements Portal {
         TeleportTransition.PostTeleportTransition postTeleportTransition;
         if (optional.isPresent()) {
             BlockPos blockPos = optional.get();
+            // SurvivalCore start - Portal trap protection
+            if (net.survivalcore.config.SurvivalCoreConfig.get().fixPortalTrapProtection) {
+                int clearBlocks = 0;
+                for (int cy = 1; cy <= 2; cy++) {
+                    if (level.getBlockState(blockPos.above(cy)).isAir()) clearBlocks++;
+                }
+                if (!net.survivalcore.fixes.ExploitFixes.isPortalExitSafe(clearBlocks)) {
+                    for (int cy = 1; cy <= 2; cy++) {
+                        BlockPos clearPos = blockPos.above(cy);
+                        if (!level.getBlockState(clearPos).isAir()) {
+                            level.removeBlock(clearPos, false);
+                        }
+                    }
+                }
+            }
+            // SurvivalCore end
             BlockState blockState = level.getBlockState(blockPos);
             largestRectangleAround = BlockUtil.getLargestRectangleAround(
                 blockPos,
diff --git a/net/minecraft/world/level/block/piston/PistonBaseBlock.java b/net/minecraft/world/level/block/piston/PistonBaseBlock.java
index 10484ee85482e86be5e0a09d8202df600a32092e..0c1f680574a0bf93168f537a6396116a80267811 100644
--- a/net/minecraft/world/level/block/piston/PistonBaseBlock.java
+++ b/net/minecraft/world/level/block/piston/PistonBaseBlock.java
@@ -102,6 +102,15 @@ public class PistonBaseBlock extends DirectionalBlock {
     private void checkIfExtend(Level level, BlockPos pos, BlockState state) {
         Direction direction = state.getValue(FACING);
         boolean neighborSignal = this.getNeighborSignal(level, pos, direction);
+        // SurvivalCore start - Headless piston prevention
+        if (net.survivalcore.config.SurvivalCoreConfig.get().fixHeadlessPiston) {
+            boolean isExtended = state.getValue(EXTENDED);
+            boolean isBeingPushed = level.getBlockState(pos.relative(direction.getOpposite())).is(net.minecraft.world.level.block.Blocks.MOVING_PISTON);
+            if (!net.survivalcore.fixes.ExploitFixes.isPistonOperationValid(isExtended, isBeingPushed)) {
+                return;
+            }
+        }
+        // SurvivalCore end
         if (neighborSignal && !state.getValue(EXTENDED)) {
             if (new PistonStructureResolver(level, pos, direction, true).resolve()) {
                 level.blockEvent(pos, this, 0, direction.get3DDataValue());
